<!DOCTYPE html>
<head>
  <link rel="import" href="resources/style.html">
  <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"
      integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
      crossorigin="anonymous"></script>
  <script src="semantic/dist/semantic.min.js"></script>
  <style>
    .table {
      table-layout: fixed;
    }
  </style>
  <!-- TODO: Should we use plain old D3. Examples:
  https://bl.ocks.org/mbostock/3887235
  https://stackoverflow.com/questions/36295050/d3-pie-charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script>
    // TODO: This should be an option for the user.
    var numberOfYearsToProject = 15;
    function PMT(interestRate, numberPeriods, loanAmount) {
      var discountFactor = (Math.pow(1 + interestRate, numberPeriods) - 1) / (interestRate * Math.pow(1 + interestRate, numberPeriods));
      return loanAmount / discountFactor;
    }

    function preparePage() {
      // Initialize semantics.
      $(".ui.accordion").accordion();

      // TODO: Plug the real data.
      populateData(generateFakeData());
    }

    function generateFakeData() {
      return {
        "property": {
          "name": "High St",
          "type": "commercial",
          "price": 799000,
          "address": "123 High St, Oakland",
          "zip": 99999,
        },
        "mortgage": {
          //"amount": 80000,
          "downpayment": 0.35,
          "interest": 0.0525,
          "lengthYears": 30,
        },
        "closingCosts": {
          "amount": 15980,
          "repairs": 10000,
        },
        "incomeStreams": {
          // TODO: For PV analysis, we should probably allow for timed income streams.
          "rent": 6150,
          "other": 0,
        },
        "expenses": {
          // TODO: Some of these values are based on GOI, some GSI, some price and some absolute.
          "water": 0,
          "electricity": 0,
          "insurance": 233,
          "RAP fee": 17,
          "property tax": 899.42,
          "business tax": 86,
          "vacancy": .05,
          "maintenance": .10,
        },
        "future": {
          "rentIncrease": 0.005,
          "expenseIncrease": 0.03,
          "appreciation": 0.02,
        },
        "tax": {
          "bracket": 0.33,
          "percentValueOfImprovement": .75,
        }
      };
    }

    function computeFinancials(info) {
      var financials = {};
      financials.monthlyGrossIncome = [ info.incomeStreams.rent + info.incomeStreams.other ];
      financials.vacancies = [info.expenses.vacancy * financials.monthlyGrossIncome[0]];
      financials.monthlyOperatingExpenses = [0];
      financials.loanAmount = [];
      // TODO: HACK to avoid repeating this for loop. FIX!!!!
      financials.expensesForChart = [['Expense', '$']];
      for (var expense in info.expenses) {
        // TODO: It's gross to ignore vacancy. It should be moved out of the operating expenses.
        if (expense === "vacancy")
          continue;

        // TODO: Gross.
        var expenseAmount = 0;
        if (expense == "maintenance") {
          expenseAmount += info.expenses[expense] * financials.monthlyGrossIncome[0];
        } else {
          expenseAmount = info.expenses[expense];
        }
        financials.monthlyOperatingExpenses[0] += expenseAmount;
        financials.expensesForChart.push([expense, expenseAmount]);
      }
      financials.expensesForChart.push(["vacancy", financials.vacancies[0]]);
      financials.equity = [ info.mortgage.downpayment * info.property.price + info.closingCosts.amount + info.closingCosts.repairs ];
      financials.noi = [ 12 * (financials.monthlyGrossIncome[0] - financials.monthlyOperatingExpenses[0] - financials.vacancies[0]) ];
      // TODO: Rename to principalRemaining.
      financials.loanAmount.push((1 - info.mortgage.downpayment) * info.property.price);
      financials.monthlyDebtService = PMT(info.mortgage.interest / 12, info.mortgage.lengthYears * 12, financials.loanAmount);
      financials.cashflow = [ financials.noi[0] - 12 * financials.monthlyDebtService ];
      financials.propertyValue = [ info.property.price ];

      var nextYearEquity = financials.equity[0];

      // Return on equity.
      financials.cashflowROE = [financials.cashflow[0] / financials.equity[0]];
      var equityAccrued = info.future.appreciation * financials.propertyValue[0];
      nextYearEquity += equityAccrued;
      financials.propertyValue.push(financials.propertyValue[0] + equityAccrued);
      financials.appreciationROE = [ equityAccrued / financials.equity[0]];
      financials.loanReductionROE = [];
      var interests = 0;
      var loanReduction = 0;
      for (var k = 0; k < 12; ++k) {
        var interest = (financials.loanAmount[0] - loanReduction) * (info.mortgage.interest / 12);
        loanReduction += financials.monthlyDebtService - interest;
        interests += interest;
      }
      nextYearEquity += loanReduction;
      financials.loanAmount.push(financials.loanAmount[0] - loanReduction);
      financials.equity.push(nextYearEquity);
      financials.loanReductionROE = [];
      financials.loanReductionROE.push(loanReduction / financials.equity[0]);
      // Compute the depreciation. Per the IRS, it depends on the type of property.
      // TODO: Make those computation work for other countries.
      var depreciationOfAsset = info.tax.percentValueOfImprovement * info.property.price;
      if (info.property.type === "commercial") {
        depreciationOfAsset /= 39;
      } else {
        depreciationOfAsset /= 27.5;
      }
      var remainingTaxDeduction = (depreciationOfAsset + info.closingCosts.repairs + interest) - financials.cashflow[0];
      financials.taxROE = [ (remainingTaxDeduction * info.tax.bracket) / financials.equity[0] ];

      financials.totalROE = [ financials.cashflowROE[0] + financials.appreciationROE[0] + financials.loanReductionROE[0] + financials.taxROE[0] ];

      for (var i = 1; i < numberOfYearsToProject; ++i) {
        financials.monthlyGrossIncome.push(financials.monthlyGrossIncome[i - 1] * (1 + info.future.rentIncrease));
        financials.vacancies.push(info.expenses.vacancy * financials.monthlyGrossIncome[i]);
        financials.monthlyOperatingExpenses.push(financials.monthlyOperatingExpenses[i - 1] * (1 + info.future.expenseIncrease));
        financials.noi.push(12 * (financials.monthlyGrossIncome[i] - financials.monthlyOperatingExpenses[i] - financials.vacancies[i]));
        financials.cashflow.push(financials.noi[i] - 12 * financials.monthlyDebtService);

        var nextYearEquity = financials.equity[i];

        // Return on equity.
        financials.cashflowROE.push(financials.cashflow[i] / financials.equity[i]);
        var equityAccrued = info.future.appreciation * financials.propertyValue[i];
        nextYearEquity += equityAccrued;
        financials.propertyValue.push(financials.propertyValue[i] + equityAccrued);
        financials.appreciationROE.push(equityAccrued / financials.equity[i]);

        nextYearEquity += equityAccrued;
        financials.appreciationROE.push(equityAccrued / financials.equity[i]);
        var interests = 0;
        var loanReduction = 0;
        for (var k = 0; k < 12; ++k) {
          var interest = (financials.loanAmount[i] - loanReduction) * (info.mortgage.interest / 12);
          loanReduction += financials.monthlyDebtService - interest;
          interests += interest;
        }
        nextYearEquity += loanReduction;
        financials.loanAmount.push(financials.loanAmount[i] - loanReduction);
        financials.loanReductionROE.push(loanReduction / financials.equity[i]);
        financials.equity.push(nextYearEquity);
        financials.loanReductionROE.push(loanReduction / financials.equity[i]);
        var remainingTaxDeduction = (depreciationOfAsset + interest) - financials.cashflow[i];
        financials.taxROE.push((remainingTaxDeduction * info.tax.bracket) / financials.equity[i]);

        financials.totalROE.push(financials.cashflowROE[i] + financials.appreciationROE[i] + financials.loanReductionROE[i] + financials.taxROE[i]);
      }

      return financials;
    }

    function populateData(info) {
      var financials = computeFinancials(info);
      // TODO: Support other locales and currencies?
      var currencyFormatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        maximumFractionDigits: 2,
      });
      var percentFormatter = new Intl.NumberFormat('en-US', {
        style: 'percent',
        maximumFractionDigits: 2,
      });

      // Set up the common values.
      $("#name").replaceWith(info.property.name);
      $("#price").replaceWith(currencyFormatter.format(info.property.price));
      $("#closingCosts").replaceWith(currencyFormatter.format(info.closingCosts.amount));
      $("#repairs").replaceWith(currencyFormatter.format(info.closingCosts.repairs));
      $("#cashOutlay").replaceWith(currencyFormatter.format(financials.equity[0]));

      $("#goi").replaceWith(currencyFormatter.format(financials.monthlyGrossIncome[0]));
      $("#vacancy").replaceWith(currencyFormatter.format(financials.vacancies[0]));

      $("#expenses").replaceWith(currencyFormatter.format(financials.monthlyOperatingExpenses[0]));

      google.charts.setOnLoadCallback(function() {
        var data = google.visualization.arrayToDataTable(financials.expensesForChart);
        var options = {
          title: 'Expenses breakdown'
        };

        var chart = new google.visualization.PieChart(document.getElementById('piechart'));

        chart.draw(data, options);
      });

      $("#noi").replaceWith(currencyFormatter.format(financials.noi[0]));
      $("#caprate").replaceWith(percentFormatter.format(financials.noi[0] / info.property.price));
      $("#debtService").replaceWith(currencyFormatter.format(financials.monthlyDebtService));
      $("#cashflow").replaceWith(currencyFormatter.format(financials.cashflow[0] / 12));

      // Set up the property details tab.
      $("#address").replaceWith(info.property.address);
      $("#zip").replaceWith(info.property.zip);

      // Set up the financing tab.
      // TODO: Allow multiple loans.
      // TODO: We should allow percentage and absolute amount.
      $("#loanAmount").replaceWith(currencyFormatter.format(financials.loanAmount[0]));
      $("#interest").replaceWith(percentFormatter.format(info.mortgage.interest));
      $("#lengthYears").replaceWith(info.mortgage.lengthYears);
      $("#monthlyPayment").replaceWith(currencyFormatter.format(financials.monthlyDebtService));

      // Performance metrics
      $("#cashflowROE").replaceWith(percentFormatter.format(financials.cashflowROE[0]));
      $("#appreciationROE").replaceWith(percentFormatter.format(financials.appreciationROE[0]));
      $("#equityBuildROE").replaceWith(percentFormatter.format(financials.loanReductionROE[0]));
      $("#taxROE").replaceWith(percentFormatter.format(financials.taxROE[0]));
      $("#totalROE").replaceWith(percentFormatter.format(financials.totalROE[0]));

      // TODO: This should be templatized and automated.
      // Populate the projections table.
      // We accumulate the DOM operations into the 2 table
      // sections to avoid touching the DOM too often.
      var thead = document.createElement("thead");
      var td = document.createElement("td");
      td.appendChild(document.createTextNode("Metric"));
      thead.appendChild(td);
      for (var i = 0; i < numberOfYearsToProject; ++i) {
        var td = document.createElement("td");
        td.appendChild(document.createTextNode("Year " + (i + 1)));
        thead.appendChild(td);
      }

      var tbody = document.createElement("tbody");
      var metrics = ["noi", "cashflow", "cashflowROE", "appreciationROE", "loanReductionROE", "taxROE", "totalROE"];
      for (var i = 0; i < metrics.length; ++i) {
        var metric = metrics[i];
        var tr = document.createElement("tr");
        var td = document.createElement("td");
        // TODO: Those are not great labels :(
        td.appendChild(document.createTextNode(metric));
        tr.appendChild(td);
        for (var j = 0; j < numberOfYearsToProject; ++j) {
          var td = document.createElement("td");
          var content;
          if (metric === "noi" || metric === "cashflow") {
            content = currencyFormatter.format(financials[metric][j]);
          } else {
            content = percentFormatter.format(financials[metric][j]);
          }
          td.appendChild(document.createTextNode(content));
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      var projectionsTable = $("#projections").get()[0];
      projectionsTable.appendChild(thead);
      projectionsTable.appendChild(tbody);

      // TODO: Set up IRR and PV analysis.
    }
    window.addEventListener("load", preparePage, false);
    google.charts.load('current', {'packages':['corechart']});
  </script>
</head>
<body>
<!-- Data for year 1:

Year 1 metrics:
- DSCR, GRM, CapRate, price
- Diagram spendings.
All year metrics:
- GOI, all expenses (vacancies vs rest? (gas, electricity, ...)), NOI, cash flow
- ROIs (cash-on-cash,COE, equity build, tax savings, total), cash flow per year, per unit per m
-->
<div class="ui segment accordion">
  <div class="ui title">
    <div class="ui header">
      <i class="dropdown icon"></i>
      Property name: <span id="name"></span>
    </div>
    <table class="ui very basic collapsing table">
      <tr><td>Property price</td><td> <span id="price"></span></td></tr>
      <tr><td>CapRate</td><td> <span id="caprate"></span></td></tr>
    </table>
  </div>
  <div class="content">
    <table class="ui very basic collapsing table">
      <tr><td>Property address</td><td><span id="address"></span></td></tr>
      <tr><td>ZIP</td><td><span id="zip"></span></td></tr>
    </table>
  </div>
</div>
<div class="ui segments context">
  <div class="ui blue segment">
    <div class="ui header">
      Performance metrics
    </div>
    <table class="ui very basic collapsing table">
      <tr><td>Cashflow return on equity</td><td> <span id="cashflowROE"></span></td></tr>
      <tr><td>Appreciation return on equity</td><td> <span id="appreciationROE"></span></td></tr>
      <tr><td>Equity build return on equity</td><td> <span id="equityBuildROE"></span></td></tr>
      <tr><td>Tax return on equity</td><td> <span id="taxROE"></span></td></tr>
      <tr><td>Total return on equity</td><td> <span id="totalROE"></span></td></tr>
    </table>
  </div>

  <div class="ui blue segment">
    <div class="ui header">Expenses</div>
    <!-- TODO: Add a numeric breakdown for all the expenses -->
    <div id="piechart" style="width:800px; height:500px"></div>
  </div>

  <!-- NOT REFACTORED AFTER THIS POINT -->
  <div class="ui blue segment">
    <table class="ui very basic collapsing table">
      <tr><td>Closing costs</td><td> <span id="closingCosts"></span></td></tr>
      <tr><td>Repairs</td><td><span id="repairs"></span></td></tr>
      <tr><td>Cash outlay</td><td><span id="cashOutlay"></span></td></tr>
    </table>
  </div>

  <div class="ui blue segment">
     <table class="ui very basic collapsing table">
      <tr><td>GOI</td><td> <span id="goi"></td></tr>
      <tr><td>Vacancy</td><td> <span id="vacancy"></td></tr>
      <tr><td>Expenses</td><td> <span id="expenses"></td></tr>
      <tr><td>NOI</td><td> <span id="noi"></td></tr>
      <tr><td>Debt Service</td><td> <span id="debtService"></td></tr>
      <tr><td>Cashflow</td><td> <span id="cashflow"></td></tr>
    </table>
  </div>
  <div class="ui blue segment">
    <table class="ui very basic collapsing table">
    <thead>
      <tr><td colspan="2"><div class="ui sub header title">Financing</div></td></tr>
    </thead>
    <tbody>
      <tr><td>Loan amount</td><td> <span id="loanAmount"></td></tr>
      <tr><td>Interest rate</td><td> <span id="interest"></td></tr>
      <tr><td>Length (years)</td><td> <span id="lengthYears"></td></tr>
      <tr><td>Mortgage payment</td><td> <span id="monthlyPayment"></td></tr>
    </tbody>
    </table>
  </div>
</div>
<!-- TODO: Total interest? Total cost? -->
<!-- Debt service 3m, 6m? -->
<div class="ui accordion">
  <div class="title">
    <i class="dropdown icon"></i>
    Yearly projections
  </div>
  <div class="content">
    <p class="transition hidden">
      <table id="projections" class="ui very basic collapsing table">
      </table>
    </p>
  </div>
</div>
<div class="ui accordion">
  <div class="title">
    <i class="dropdown icon"></i>
    IRR
  </div>
  <div class="content">
    <p class="transition hidden">TODO: Implement.</p>
  </div>
</div>
<div class="ui accordion">
  <div class="title">
    <i class="dropdown icon"></i>
    Present value Analysis
  </div>
  <div class="content">
    <p class="transition hidden">TODO: Implement.</p>
  </div>
</div>
